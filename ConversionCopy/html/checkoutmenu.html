<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Restaurant Menu + Checkout</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --accent:#111827;
      --accentText:#ffffff;
      --shadow: 0 8px 24px rgba(15,23,42,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: url("../img/S4.png") no-repeat center center fixed;
      background-size: cover;
    }
    .wrap{
      max-width: 1160px;
      margin: 0 auto;
      padding: 28px 16px 40px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      margin-bottom: 18px;
    }
    h1{
      margin:0;
      font-size: 30px;
      letter-spacing: -0.02em;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size: 14px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.6);
      border-radius: 999px;
      color: var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
    }
    @media (min-width: 980px){
      .grid{
        grid-template-columns: 1fr 380px;
        align-items:start;
      }
      .sticky{
        position: sticky;
        top: 18px;
      }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--border);
    }
    .card .bd{
      padding: 16px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .title{
      font-weight: 700;
      font-size: 18px;
      margin:0;
    }
    .desc{
      margin:6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .tags{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tag{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: #334155;
    }
    .priceCol{
      text-align:right;
      min-width: 90px;
    }
    .from{
      font-size:12px;
      color: var(--muted);
    }
    .basePrice{
      font-weight: 800;
      font-size: 16px;
      margin-top:2px;
    }
    .opts{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 720px){
      .opts{
        grid-template-columns: 1fr 1fr;
      }
    }
    .optGroup .lbl{
      font-size: 13px;
      font-weight: 650;
      margin-bottom: 7px;
    }
    select, input[type="number"]{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: #fff;
      color: var(--text);
      outline: none;
    }
    input[type="number"]{
      padding: 9px 10px;
    }
    select:focus, input[type="number"]:focus{
      box-shadow: 0 0 0 3px rgba(15,23,42,.08);
      border-color: #cbd5e1;
    }

    .addon{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
      font-size: 13px;
      margin-top:8px;
    }
    .addon:first-of-type{ margin-top:0 }
    .addonLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .addonLeft label{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
      min-width: 0;
    }
    .addonRight{
      color: var(--muted);
      white-space:nowrap;
    }

    .sep{
      height:1px;
      background: var(--border);
      margin: 14px 0;
    }

    .qtyAdd{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    @media (min-width: 560px){
      .qtyAdd{
        flex-direction: row;
        align-items:center;
        justify-content:space-between;
      }
    }
    .qtyBox{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .qtyBox .lbl{
      font-size: 13px;
      font-weight: 650;
    }
    .qtyBox input{
      width: 92px;
    }
    .yourPrice{
      text-align:right;
    }
    .yourPrice .muted{ font-size: 12px; color: var(--muted); }
    .yourPrice .big{ font-size: 18px; font-weight: 800; margin-top: 2px; }

    .btn{
      appearance:none;
      border:none;
      border-radius: 16px;
      padding: 10px 14px;
      font-weight: 650;
      cursor:pointer;
    }
    .btn.primary{
      background: var(--accent);
      color: var(--accentText);
    }
    .btn.primary:hover{ filter: brightness(1.05); }
    .btn.ghost{
      background: transparent;
      border: 1px solid var(--border);
      color: #334155;
    }
    .btn.ghost:hover{ background: #f8fafc; }
    .btn.block{
      width:100%;
      padding: 14px 16px;
      border-radius: 18px;
      font-size: 15px;
    }

    /* Checkout */
    .checkoutEmpty{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 18px;
      padding: 14px;
      color: var(--muted);
      font-size: 13px;
    }
    .cartLines{ display:flex; flex-direction:column; gap: 12px; }
    .line{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 18px;
      padding: 12px;
    }
    .lineTop{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .lineName{ font-weight: 700; font-size: 14px; margin:0; }
    .lineMeta{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .trash{
      border:none;
      background: transparent;
      cursor:pointer;
      padding: 6px;
      border-radius: 12px;
      color: #64748b;
    }
    .trash:hover{ background: #f1f5f9; color:#0f172a; }
    .lineBottom{
      margin-top: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .lineQty{
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .lineQty input{
      width: 76px;
      height: 36px;
      border-radius: 14px;
    }
    .lineNums{
      display:flex;
      gap: 16px;
      align-items:flex-end;
    }
    .numBox{
      text-align:right;
      min-width: 70px;
    }
    .numBox .muted{ font-size: 11px; color: var(--muted); }
    .numBox .val{ font-size: 13px; font-weight: 750; margin-top: 2px; }
    .numBox .val.strong{ font-size: 14px; font-weight: 850; }

    .totals{ font-size: 13px; }
    .totals .trow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top: 8px;
      color:#0f172a;
    }
    .totals .trow span:first-child{ color: var(--muted); }
    .totals .trow strong{ font-weight: 850; }
    .help{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
    }

    .miniCard{
      margin-top: 14px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background:#fff;
      box-shadow: var(--shadow);
      padding: 14px 16px;
    }
    .miniCard .mtitle{ font-weight: 750; font-size: 13px; }
    .miniCard ul{ margin: 8px 0 0; padding-left: 18px; color: var(--muted); font-size: 13px; }
    .miniCard li{ margin: 6px 0; }

    .back-btn {
    margin-top:15px;
    margin-left: 15px;
    width: 40px;
    height: 30px;
  }
  </style>
</head>
<body>
  <div class = "topBar">
    <button class = "back-btn" onclick="backPress()">‚Üê</button>
  </div>
  <div class="wrap">
    <header>
      <div>
        <h1 id="restName" ></h1>
        <div class="sub">Pick options, add to cart, and checkout on the right.</div>
      </div>
      <div class="pill" id="cartPill">üõí <span id="cartCount">0</span> items</div>
    </header>

    <div class="grid">
      <!-- LEFT: MENU -->
      <main id="menuCol" class="menu"></main>

      <!-- RIGHT: CHECKOUT -->
      <aside class="sticky">
        <section class="card">
          <div class="hd">
            <div class="row">
              <div class="title">Checkout</div>
              <button class="btn ghost" id="clearBtn" type="button" style="display:none">Clear</button>
            </div>
          </div>
          <div class="bd">
            <div id="cartArea"></div>

            <div class="sep"></div>

            <div class="totals">
              <div class="trow"><span>Subtotal</span><strong id="subTotal">$0.00</strong></div>
              <div class="trow"><span>Tax (<span id="taxRateText"></span>)</span><strong id="taxAmt">$0.00</strong></div>
              <div class="trow" style="font-size:15px"><span style="color:#0f172a;font-weight:850">Total</span><strong id="totalAmt">$0.00</strong></div>
            </div>

            <div style="margin-top:14px">
              <button class="btn primary block" id="placeOrderBtn" type="button">Place order</button>
              <div class="help">Demo checkout only. Hook this up to your backend/payment flow.</div>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <script type ="module">
    //====Imports=====//
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

console.log("map.js loaded");
const firebaseConfig = {
  databaseURL: "https://savordatabase-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const savorDB = getDatabase(app);
    // ===== Data =====

    const TAX_RATE = 0.0875;
    sessionStorage.setItem("taxRate", TAX_RATE);
    const state = {
      drafts: {},   // per item: { selections, qty }
      cart: [],     // lines: { lineId, itemId, name, selections, unitPrice, qty }
      items: []
    };
    

    document.getElementById("restName").innerText =
  sessionStorage.getItem("currRest");

window.backPress = function() {
  sessionStorage.removeItem("currRest");
  window.location.href = '../html/map.html';
}

async function renderMenu() {
  const rest = sessionStorage.getItem("currRest");
  const menuItemsRef = ref(savorDB, `rest/${rest}/menu`);
  const menuItems = document.getElementById("menuCol");
  const snapshot = await get(menuItemsRef);
  if(!snapshot.exists()) return;

  state.items = []; // reset items array

  snapshot.forEach(child => {
    const data = child.val();
    const itemObj = {
      id: child.key,
      name: data.name,
      desc: data.desc,
      price: data.price,
      imageURL: data.image || "" // fixed typo & default empty
    };
    state.items.push(itemObj);
  });

  menuItems.innerHTML = ""; // clear previous content

  state.items.forEach(item => {
    const menuItem = document.createElement("section");
    menuItem.className = "card"; // optional styling

    menuItem.innerHTML = `
      <div class="hd">
        <div class="row">
          <div>
            <div class="title">${item.name}</div>
            <div class="desc">${item.desc}</div>
          </div>
          <div>
            ${item.imageURL ? `<img src="${item.imageURL}" alt="${item.name}" style="max-width:80px; border-radius:8px;">` : ""}
          </div>
          <div class="priceCol">
            <div class="from">From</div>
            <div class="basePrice">$${item.price.toFixed(2)}</div>
          </div>
        </div>
      </div>
      <div class="bd">
        <div class="sep"></div>
        <div class="qtyAdd">
          <div class="qtyBox">
            <div class="lbl">Quantity</div>
            <input type="number" min="1" value="1" id="qty-${item.id}">
          </div>
          <div class="row" style="align-items:center">
            <div class="yourPrice">
              <div class="muted">Your price</div>
              <div class="big" id="your-${item.id}">$${item.price.toFixed(2)}</div>
            </div>
            <button class="btn primary" type="button" data-id="${item.id}">Add to cart</button>
          </div>
        </div>
      </div>
    `;

    menuItems.appendChild(menuItem);
  });
}

function updateTotals() {
  const subtotal = state.cart.reduce((sum, l) => sum + l.unitPrice * l.qty, 0);
  const tax = subtotal * TAX_RATE;
  const total = subtotal + tax;

  document.getElementById("subTotal").textContent = `$${subtotal.toFixed(2)}`;
  document.getElementById("taxAmt").textContent = `$${tax.toFixed(2)}`;
  document.getElementById("totalAmt").textContent = `$${total.toFixed(2)}`;
  document.getElementById("taxRateText").textContent = (TAX_RATE*100).toFixed(2) + "%";
  let cartItemCount = 0;
  for (let x = 0; x < state.cart.length; x++) 
  {
      cartItemCount += Number(state.cart[x].qty);
  }
  document.getElementById("cartCount").textContent = cartItemCount;
}

// ---- Updated renderCart ----
function renderCart() {
  const cartArea = document.getElementById("cartArea");
  const clearBtn = document.getElementById("clearBtn");

  if (!state.cart.length) {
    cartArea.innerHTML = '<div class="checkoutEmpty">Your cart is empty</div>';
    clearBtn.style.display = "none";
    updateTotals();
    return;
  }

  clearBtn.style.display = "inline-flex";

  const wrap = document.createElement("div");
  wrap.className = "cartLines";

  state.cart.forEach(line => {
    const item = state.items.find(i => i.id === line.itemId);

    const div = document.createElement("div");
    div.className = "line";

    div.innerHTML = `
      <div class="lineTop">
        <div style="min-width:0">
          <p class="lineName">${line.name}</p>
        </div>
        <button class="trash" type="button" title="Remove">üóëÔ∏è</button>
      </div>
      <div class="lineBottom">
        <div class="lineQty">
          <span>Qty</span>
          <input type="number" min="1" value="${line.qty}" />
        </div>
        <div class="lineNums">
          <div class="numBox">
            <div class="muted">Unit</div>
            <div class="val">$${line.unitPrice.toFixed(2)}</div>
          </div>
          <div class="numBox">
            <div class="muted">Line</div>
            <div class="val strong">$${(line.unitPrice * line.qty).toFixed(2)}</div>
          </div>
        </div>
      </div>
    `;

    // ---- Remove item from cart ----
    div.querySelector(".trash").addEventListener("click", () => {
      state.cart = state.cart.filter(l => l.itemId !== line.itemId);
      syncUI(); // re-render cart & totals
    });

    // ---- Update qty ----
    div.querySelector("input[type=number]").addEventListener("input", e => {
      const v = Math.max(1, Number(e.target.value || 1));
      line.qty = v;
      syncUI(); // re-render totals
    });

    wrap.appendChild(div);
  });

  cartArea.innerHTML = "";
  cartArea.appendChild(wrap);

  updateTotals();
  syncUI();
}



function addToCart(itemId) {
  const item = state.items.find(i => i.id === itemId);
  if (!item) return;

  // Read quantity from input box
  const qtyInput = document.getElementById(`qty-${itemId}`);
  const qty = qtyInput ? Math.max(1, parseInt(qtyInput.value) || 1) : 1;

  // Check if item is already in cart
  if(state.cart === undefined)
  {
    state.cart = [];
  }
  const existing = state.cart.find(l => l.itemId === itemId);
  if (existing) {
    existing.qty += qty;
  } else {
    state.cart.push({
      itemId: item.id,
      name: item.name,
      unitPrice: item.price,
      qty
    });
  }

  console.log("Cart:", state.cart);
  syncUI();
}



function clearCart(){
  state.cart = [];
  syncUI();
}

function syncUI(){
  renderCart();
}

function getTimestamp() {
  const now = new Date();

  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const year = now.getFullYear();

  let hours = now.getHours();
  const minutes = String(now.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'pm' : 'am';

  hours = hours % 12 || 12; // convert 0 ‚Üí 12

  return `${month}${day}${year}/${hours}:${minutes}${ampm}`;
}


function getRandom(max) {
  return Math.floor(Math.random() * max);
}


function payCheck(){
  if(!sessionStorage.getItem("currOrder")){
    const x = getRandom(1000);
  const items = state.cart;
  let user = "guest";
  if (localStorage.getItem("loggedInUser")) {
    user = localStorage.getItem("loggedInUser");
  }
  const pickupTime = getTimestamp();
  const rest = sessionStorage.getItem("currRest");
  const totalPrice = parseFloat(document.getElementById("totalAmt").innerText.replace("$", ""));
  const status = "pending";
  const taxRate = TAX_RATE;

  sessionStorage.setItem("currOrder", x);
  const orderRef = ref(savorDB, `order/${x}`);
  set(orderRef, {items,pickupTime,rest,totalPrice,user,status,taxRate })
  .then(() => {
    location.href = `paymentCheckout.html`;
  })
  .catch(err => {
    console.log("Error creating order",err);
    alert("Failed to create order.");
  })
  }else{
    const items = state.cart;
    const pickupTime = getTimestamp();
    const totalPrice = parseFloat(document.getElementById("totalAmt").innerText.replace("$", ""));
    const orderRef = ref(savorDB, `order/${sessionStorage.getItem("currOrder")}`);
    update(orderRef, {items,totalPrice,pickupTime})
    location.href = 'paymentCheckout.html';
  }
}

//===Events===//
document.getElementById("menuCol").addEventListener("click", (e) => {
  if (!e.target.matches("button.btn.primary")) return;

  const itemId = e.target.dataset.id; // get the ID from data-id
  addToCart(itemId);
});

document.getElementById("clearBtn")
  .addEventListener("click", clearCart);

document.getElementById("placeOrderBtn")
  .addEventListener("click", payCheck);
async function checkOrderVal()
{
  if(sessionStorage.getItem("currOrder"))
  {
    const orderRef = ref(savorDB,`order/${sessionStorage.getItem("currOrder")}`);
    const snapshotRef = await get(orderRef);
    const orderPrev = snapshotRef.val();
    state.cart = orderPrev.items;
    renderCart();
  }
  else
  {
    return;
  }
}

//==Boot==//
renderMenu();
checkOrderVal();
  </script>
</body>
</html>

