<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  
<style>
body {
  margin: 0;
  padding: 0;
  height: 100vh;
  background: url("../img/S6.png") no-repeat center center fixed;
  background-size: cover;
  font-family: 'Arial Rounded MT Bold', sans-serif;
}

.title-bar {
    position: fixed;
    top: 16px;
    left: 0;
    right: 0;

    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 5px;
    z-index: 1000;
}

.title-pickup {
    font-size: 40px; 
    color: #0a5a2e;
    margin: 0; 
    font-weight: 900;
    letter-spacing: 3px;
    text-shadow:
      0 3px 0 #c8e1c8,
      0 6px 0 #a8d1a8,
      0 9px 10px rgba(0, 0, 0, 0.25);
    overflow: hidden;
}

.settings-icon {
    width: 32px;
    height: 32px;
    cursor: pointer;
}

.pickup {
  margin-top: 10px; 
  font-size: 30px;
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  color: #0a5a2e;
}

.overlay {
  position: absolute;
  top: 6%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.title-link {
    text-decoration: none;
    color: inherit
}

.login-overlay {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
  padding-top: 0px;
}

.login-box {
  background: rgba(255, 255, 255, 0.93);
  border-radius: 25px;
  padding: 45px 60px; 
  box-shadow: 0px 6px 25px rgba(0, 0, 0, 0.3);
  text-align: center;
  width: 1000px; 
  max-height: 200vh; 
  overflow-y: auto;
  scrollbar-width: none;
}
.login-box::-webkit-scrollbar {
  display: none;
}

.login-input {
  display: block;
  width: 100%;
  padding: 13px; 
  margin-bottom: 22px; 
  border: none;
  border-radius: 10px;
  font-size: 17px; 
  background-color: #fff;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  transition: all 0.25s ease;
}

.login-input:focus {
  outline: none;
  box-shadow: 0 0 10px rgba(17, 143, 84, 0.4);
}

select.login-input {
  cursor: pointer;
  background-color: #fefefe;
}

.login-submit {
  background-color: #0a5a2e;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 15px 50px; 
  font-size: 22px;
  cursor: pointer;
  transition: 0.3s;
  margin-top: 10px; 
}

.info-bubbles {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
    justify-content: center;
}

.info-bubble {
    flex: 1 1 150px;
    padding: 12px 14px;
    border-radius: 16px;
    background: #f4faf6;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border: 1px solid rgba(17, 143, 84, 0.15);

    display: flex;
    justify-content: center;
    align-items: center;
}

.bubble-content {
    display: flex;
    flex-direction: column;
    text-align: left;
    gap: 6px;
    width: 100%;
}

.login-submit:hover {
  background-color: #118f54;
  transform: scale(1.05);
}

.login-links {
  margin-top: 30px; 
  font-size: 20px;
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
}

.login-links a {
  color: #0a5a2e;
  text-decoration: none;
  transition: color 0.2s ease;
}

.login-links a:hover {
  text-decoration: underline;
  color: #118f54;
}

@media (max-width: 500px) {
  .login-box {
    width: 90%;
    padding: 40px 25px;
  }

  .login-input {
    padding: 12px;
    font-size: 16px;
  }

  .login-submit {
    width: 100%;
    padding: 14px;
    font-size: 20px;
  }
}

#pickup-map {
  width: 100%;
  height: 300px;         
  border-radius: 18px;
  overflow: hidden;
  margin-top: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
    <div class="title-bar">
        <a href="../html/index.html" class= "title-link">
            <h1 class="title-pickup" onclick = "clearStorage()">SAVOR</h1>
        </a>

        <a href="../html/user_acc.html" class="settings-btn">
            <img src="../img/cog.png" alt="Settings" class="settings-icon" onclick = "clearStorage()">
        </a>
    </div>
  <div class="login-overlay">
    <div class="login-box">
      <h2 class="pickup">Order View</h2>
      <div id="pickup-map"></div>
      <br>
        <div class="info-bubble">
            <div class="bubble-content">
                <div class="bubble-label" id = "rest-name"></div>
                <div class="bubble-value" id = "loc"></div>
                <div class="bubble-value" id = "pickupTime"></div>
                <div class="bubble-value" id = "orderNum"> </div>
                <div class="bubble-value" id = "items"></div>
                <div class = "bubble-value" id = "tax"></div>
                <div class="bubble-value" id = "price"></div>
            </div>
        </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

console.log("Script loaded");

const firebaseConfig = {
  databaseURL: "https://savordatabase-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const savorDB = getDatabase(app);


let map = L.map("pickup-map", {
  zoomControl: false,
  attributionControl: false
}).setView([34.241461, -118.529286], 14);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
}).addTo(map);

let userLatLng = null;
let restaurantCoords = null;
let routingControl = null;


window.clearStorage = function() {
  sessionStorage.removeItem("clickedOrder");
  sessionStorage.removeItem("taxRate");
  sessionStorage.removeItem("currRest");
  sessionStorage.removeItem("currOrder");
};


function startRouting() {
  if (!userLatLng || !restaurantCoords) return;

  if (routingControl) {
    map.removeControl(routingControl);
  }

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLatLng),
      L.latLng(restaurantCoords)
    ],
    addWaypoints: false,
    draggableWaypoints: false,
    show: false,
    createMarker: () => null
  }).addTo(map);

  const bounds = L.latLngBounds([userLatLng, restaurantCoords]);
  map.fitBounds(bounds, { padding: [20, 20] });
}


navigator.geolocation?.getCurrentPosition(
  (pos) => {
    userLatLng = [pos.coords.latitude, pos.coords.longitude];

    L.marker(userLatLng).addTo(map).bindPopup("Your location");

    startRouting();
  },
  () => {
    console.log("User denied geolocation.");
  }
);


async function fetchAddress(lat, lng) {
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
      {
        headers: { "User-Agent": "S4VOR-Student-Project" }
      }
    );
    const data = await res.json();
    return data.display_name || "Address not available";
  } catch (err) {
    console.error("Address lookup failed", err);
    return "Address not available";
  }
}

async function loadOrder() {
  const orderNum = sessionStorage.getItem("currOrder");
  if (!orderNum) return;

  const ord = ref(savorDB, `order/${orderNum}`);
  const snapshot = await get(ord);
  if (!snapshot.exists()) return;

  const order = snapshot.val();

  const restRef = ref(savorDB, `rest/${order.rest}`);
  const snapshotRest = await get(restRef);
  if (!snapshotRest.exists()) return;

  const restVal = snapshotRest.val();

  restaurantCoords = [restVal.lat, restVal.lng];

  L.marker(restaurantCoords).addTo(map).bindPopup("Pickup location");

  fetchAddress(restVal.lat, restVal.lng).then(address => {
    document.getElementById("loc").innerHTML =
      `<strong>${address}</strong><br>`;
  });

  startRouting();

  document.getElementById("rest-name").innerHTML =
    `<strong>${order.rest}</strong><br>`;

  document.getElementById("pickupTime").innerHTML =
    `<strong>${order.pickupTime}</strong><br>`;

  const itemsEl = document.getElementById("items");
  itemsEl.innerHTML = "";

  let totItemPrice = 0;

  Object.values(order.items).forEach(item => {
    const row = document.createElement("div");
    row.textContent =
      `${item.name} - $${item.unitPrice} x ${item.qty} = $${(item.unitPrice * item.qty).toFixed(2)}`;
    itemsEl.appendChild(row);
    totItemPrice += item.unitPrice * item.qty;
  });

  document.getElementById("tax").innerHTML =
    `<br><strong>Tax: $${(order.totalPrice - totItemPrice).toFixed(2)}</strong>`;

  document.getElementById("price").innerHTML =
    `<br><strong>Total: $${order.totalPrice.toFixed(2)}</strong>`;
}

loadOrder();
</script>

</body>
</html>