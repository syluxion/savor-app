<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile-settings - Savor</title>
  <style>
    /*Restaurant Account Css*/

body {
  margin: 0;
  padding: 0;
  height: 100vh;
  background: url("../img/S6.png") no-repeat center center fixed;
  background-size: cover;
  font-family: 'Arial Rounded MT Bold', sans-serif;
}

.settings-layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    gap: 24px;
    height: 100vh;
    padding: 24px;
    box-sizing: border-box;
}

.settings-nav {
    background: rgba(255, 255, 255, 0.93);
    border-radius: 25px;
    padding: 24px;
    box-shadow: 0px 6px 25px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow: auto;
    height: auto;
    max-height: none;
    /* max-height: calc(100vh - 48px); */
}

.settings-nav .app-title {
    margin: 0 0 8px 0;
    color: #0a5a2e;
    font-size: 22px;
    letter-spacing: 0.5px;
}

.nav-item {
    display: block;
    width: 100%;
    text-align: left;
    padding: 12px 14px;
    background: #fff;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(0,0,0,0.08);
    transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease;
}
.nav-item:hover { transform: translateX(2px); }
.nav-item.is-active {
    background: #e7f5ee;
    box-shadow: 0 0 0 2px rgba(17, 143, 84, 0.25) inset;
}

.settings-content {
    background: rgba(255, 255, 255, 0.93);
    border-radius: 25px;
    padding: 28px 32px;
    box-shadow: 0px 6px 25px rgba(0, 0, 0, 0.3);
    overflow: auto;
    max-height: calc(100vh - 48px);
}

.profile-avatar {
    display: flex;
    justify-content: center;
    margin: 6px 0 8px;
}

.avatar-large {
    width: 96px;
    height: 96px;   
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #0a5a2e;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    background-color: #f2f2f2;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
    padding: 0 10px;
}

.header-left {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0a5a2e;
    margin: 0;
}

.header-right {
    font-size: 0.95rem;
    color: #444;
    margin: 0;
}

.settings-subtitle {
    color: #444;
    margin: 6px 0 0;
    font-size: 14px;
}

/* .panel { display: none; }
.panel.is-visible { display: block;} --> */


.card {
    background: #fff;
    border-radius: 20px;
    padding: 18px 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.info-bubbles {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
}

.info-bubble {
    flex: 1 1 150px;
    padding: 12px 14px;
    border-radius: 16px;
    background: #f4faf6;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    border: 1px solid rgba(17, 143, 84, 0.15);
}

.bubble-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #666;
    margin-bottom: 4px;
}

.bubble-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #0a5a2e;
}

.form-grid { max-width: 720px; margin: 0 auto; }
.field { margin-bottom: 16px; text-align: left; }
.field label { display: block; margin-bottom: 6px; font-weight: 600; }

.actions {display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
.status { font-size: 14px; color: #0a5a2e; }

.login-input {
  display: block;
  width: 100%;
  padding: 13px; 
  margin-bottom: 22px; 
  border: none; /* removes black outline */
  border-radius: 10px;
  font-size: 17px; 
  background-color: #fff;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
  transition: all 0.25s ease;
}

.login-input:focus {
  outline: none;
  box-shadow: 0 0 10px rgba(17, 143, 84, 0.4);
}

select.login-input {
  cursor: pointer; /* removes browser default blue outline */
  background-color: #fefefe; /*  smooth green glow */
}

.login-submit {
  background-color: #0a5a2e;
  color: white;
  border: none;
  border-radius: 25px;
  padding: 15px 50px; 
  font-size: 22px;
  cursor: pointer;
  transition: 0.3s;
  margin-top: 10px; 
}

.login-submit:hover {
  background-color: #118f54;
  transform: scale(1.05);
}

.login-links {
  margin-top: 30px; 
  font-size: 20px;
  display: flex;
  justify-content: center;
  gap: 40px;
  flex-wrap: wrap;
}

.login-links a {
  color: #0a5a2e;
  text-decoration: none;
  transition: color 0.2s ease;
}

.login-links a:hover {
  text-decoration: underline;
  color: #118f54;
}

@media (max-width: 900px) {
  .settings-layout { grid-template-columns: 1fr; padding: 16px; }
  .setting-nav, .settings-content { max-height: none; }
}

@media (max-width: 500px) {
    .settings-content { padding: 20px; }
    .login-input { padding: 12px; font-size: 16px; }
    .login-submit { width: 100%; padding: 14px; font-size: 20px; }
}

/* --- Smooth fade animation for settings panels --- */
/* Start hidden panels fully transparent */

.panel {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.4s ease, transform 0.4s ease;
  display: none; /* ensure hidden ones don't take space */
}

/* When a panel becomes visible */
.panel.is-visible {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

/* Inventory Panel Styles */
.inventory-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: calc(100vh - 150px); 
  overflow-y: auto;
}

.inventory-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #fdfdfd;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  gap: 16px;
}

.item-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 10px;
}

.item-details {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.item-description {
  font-weight: 600;
  font-size: 1rem;
  color: #0a5a2e;
}

.item-price {
  font-weight: bold;
  color: #118f54;
}

.item-quantity {
  display: flex;
  align-items: center;
  gap: 8px;
}

.item-subdescription {
  font-size: 0.9rem;
  color: #555;
}


.quantity-btn {
  width: 32px;
  height: 32px;
  border: none;
  border-radius: 6px;
  background-color: #0a5a2e;
  color: white;
  font-size: 18px;
  cursor: pointer;
}

.quantity-btn:hover {
  background-color: #118f54;
}

.quantity-input {
  width: 50px;
  text-align: center;
  font-size: 16px;
  padding: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
}

/* ---- Modal ---- */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 9999;
}
.modal.is-open { display: flex; }

.modal-card {
  width: min(720px, 100%);
  background: rgba(255,255,255,0.97);
  border-radius: 22px;
  padding: 18px 18px 22px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.35);
}

.modal-header {
  display:flex;
  justify-content: space-between;
  align-items:center;
  margin-bottom: 12px;
}

.modal-close {
  border: none;
  background: transparent;
  font-size: 20px;
  cursor: pointer;
  padding: 8px 10px;
  border-radius: 10px;
}
.modal-close:hover { background: rgba(0,0,0,0.06); }

/* ---- Dropzone ---- */
.dropzone {
  border: 2px dashed rgba(17, 143, 84, 0.45);
  border-radius: 18px;
  padding: 18px;
  margin: 10px 0 16px;
  background: #f4faf6;
  cursor: pointer;
  position: relative;
  min-height: 160px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
.dropzone.is-dragover {
  background: #e7f5ee;
  border-color: #118f54;
}

.image-preview {
  display:none;
  max-width: 100%;
  max-height: 240px;
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
.dropzone.has-image .dropzone-text { display:none; }
.dropzone.has-image .image-preview { display:block; }

/* ---- Validation (red highlight) ---- */
.login-input.is-invalid {
  box-shadow: 0 0 0 2px rgba(220, 30, 30, 0.65) inset, 0 0 10px rgba(220, 30, 30, 0.2);
}
.dropzone.is-invalid {
  border-color: rgba(220, 30, 30, 0.8);
  background: rgba(255, 220, 220, 0.55);
}

.item-action-btn {
  border: none;
  border-radius: 10px;
  padding: 8px 12px;
  cursor: pointer;
  background: #0a5a2e;
  color: #fff;
  font-size: 14px;
}
.item-action-btn:hover { background: #118f54; }

.item-action-btn.delete-btn {
  background: #b3261e;
}
.item-action-btn.delete-btn:hover {
  background: #d93025;
}

/* Small helper for new action buttons */
.item-actions {
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
}

  </style>
</head>
<body>
  <div class ="settings-layout">
    <aside class="settings-nav" aria-label="Settings sections">
      <h1 class="app-title">S4VOR</h1>
      <nav role="tablist" aria-orientation="vertical">
        <button type="button" class="nav-item is-active" role="tab" aria-selected="true" aria-controls="panel-profile" id="tab-profile">Home</button>
        
        <button type="button" class="nav-item" role="tab" aria-selected="false" aria-controls="panel-security" id="tab-security">Inventory</button>
        <button type="button" class="nav-item" role="tab" aria-selected="false" aria-controls="panel-payment" id="tab-payment">Orders & Sales</button>
        <button type="button" class="nav-item" role="tab" aria-selected="false" aria-controls="panel-locations" id="tab-locations"><a href="../html/user_acc.html">Profile Settings</a></button>
      </nav>
    </aside>

    <main class="settings-content">

      <!--<div class="profile-avatar">
        <img src="../img/user_icon.png" alt="User Avatar" class="avatar-large"/>
      </div> -->

      <header class="settings-header">
        <h2 class="header-left">Dashboard</h2>
        <p class="header-right">Restaurant Name Here</p>
      </header>

      <section id="panel-profile" class="panel is-visible" role="tabpanel" aria-labelledby="tab-profile">
        <section class="card" aria-labelledby="profile-basics-heading">
        <h3 id="profile-basics-heading"><!-- Home --></h3>
        <div class="info-bubbles">
            <div class="info-bubble">
                <div class="bubble-label">Active Listings</div>
                <div class="bubble-value">0</div>
            </div>
        </div>

        <div class="info-bubbles">
            <div class="info-bubble">
                <div class="bubble-label">Total Sales Today</div>
                <div class="bubble-value">$0.00</div>
            </div>
        </div>

        <div class="info-bubbles">
            <div class="info-bubble">
                <div class="bubble-label">Expiring Soon</div>
                <div class="bubble-value">0</div>
            </div>
        </div>

        <div class="info-bubbles">
            <div class="info-bubble">
                <div class="bubble-label">Popular Items</div>
                <ul class="bubble-list">
                    <li>1. Null</li>
                    <li>2. Null</li>
                    <li>3. Null</li>
                </ul>
            </div>
        </div>

        <form id="profileBasicsForm" class="form-grid" autocomplete="on">
          <!-- <div class="field">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" name="firstName" class="login-input"/>
          </div>
          <div class="field">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" name="lastName" class="login-input"/>
          </div>
          <div class="field">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" class="login-input"/>
          </div>
          <div class="field">
            <label for="birthDate">Birthdate</label>
            <input type="date" id="birthDate" name="birthDate" class="login-input"/>
          </div>
          <div class="field">
            <label for="phoneNumber">Phone Number</label>
            <input type="tel" id="phoneNumber" name="phoneNumber" class="login-input"/>
          </div>
          <div class="actions">
            <button type="submit" class="login-submit">Save Changes</button>
            <div id="profileBasicsStatus" class="status" aria-live="polite"></div>
          </div> -->
        </form>
        </section>
      </section> 

      <section id="panel-security" class="panel" role="tabpanel" aria-labelledby="tab-security" hidden>
        <section class="card" aria-labelledby="security-heading">
          <div class="inventory-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h3 id="security-heading">Inventory</h3>
            <button id="add-item-btn" class="login-submit" style="padding:8px 20px; font-size:16px;">Add Item</button>
          </div>
      
          <div class="inventory-list">
            <!-- Example item block -->
            <div class="inventory-item">
              <img src="../img/placeholder.png" alt="Item Image" class="item-image"/>
              <div class="item-details">
                <div class="item-description">Sample Item </div>
                <div class="item-price">$12.99</div>
              </div>
              <div class="item-quantity">
                <button class="quantity-btn minus">-</button>
                <input type="number" class="quantity-input" value="0" min="0"/>
                <button class="quantity-btn plus">+</button>
              </div>
            </div>
            <!-- Repeat inventory-item blocks as needed -->
          </div>
        </section>
      </section>

      <section id="panel-payment" class="panel" role="tabpanel" aria-labelledby="tab-payment" hidden>
        <section class="card" aria-labelledby="payment-heading">
          <h3 id="payment-heading"><!--Order & Sales--></h3>
          <form id="paymentForm" class="form-grid" autocomplete="off">
            <div class="field">
              <label>Coming Soon</label>
            </div>
          </form>
        </section>
      </section>

      <!--<section id="panel-locations" class="panel" role="tabpanel" aria-labelledby="tab-locations" hidden>
        <section class="card" aria-labelledby="locations-heading">
          <a href="../html/user_acc.html">Profile Settings</a>
          <h3 id="locations-heading">Saved Locations</h3>
          <form id="locationsForm" class="form-grid" autocomplete="off">
            <div class="field">
              <label>Add Link to user account but for restaurant owners</label>
            </div>
          </form> 
        </section>
      </section>
    </main>
   </div> -->

  <!-- ADD ITEM MODAL (paste this block right here) -->
  <div id="addItemModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addItemTitle">
      <div class="modal-header">
        <h3 id="addItemTitle" style="margin:0; color:#0a5a2e;">Add Inventory Item</h3>
        <button type="button" id="closeAddItemModal" class="modal-close" aria-label="Close">âœ•</button>
      </div>

      <div id="imageDropZone" class="dropzone" tabindex="0">
        <div class="dropzone-text">
          <strong>Drop image here</strong> or click to upload
          <div style="font-size:12px; color:#666; margin-top:6px;">PNG / JPG recommended</div>
        </div>
        <input id="itemImageInput" type="file" accept="image/*" hidden />
        <img id="imagePreview" class="image-preview" alt="Preview" />
      </div>

      <div class="form-grid" style="max-width:none;">
        <div class="field">
          <label for="itemName">Name</label>
          <input id="itemName" class="login-input" type="text" placeholder="e.g., Chocolate Cake" />
        </div>

        <div class="field">
          <label for="itemDescription">Description</label>
          <input id="itemDescription" class="login-input" type="text" placeholder="e.g., A sweet indulgence" />
        </div>

        <div class="field">
          <label for="itemQuantity">Quantity</label>
          <input id="itemQuantity" class="login-input" type="number" min="0" step="1" placeholder="e.g., 12" />
        </div>

        <div class="field">
          <label for="itemPrice">Price</label>
          <input id="itemPrice" class="login-input" type="number" min="0" step="0.01" placeholder="e.g., 11.50" />
        </div>

        <div class="actions">
          <button type="button" id="saveItemBtn" class="login-submit">Save Item</button>
          <button type="button" id="cancelItemBtn" class="login-submit" style="background:#777;">Cancel</button>
          <div id="addItemStatus" class="status" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </div>

<script type ="module">


 import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
 import { getDatabase, ref, set, get, push, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

console.log("Script loaded");

//Consts and Vars
// Firebase setup

const firebaseConfig = {
  databaseURL: "https://savordatabase-default-rtdb.firebaseio.com"
};
const app = initializeApp(firebaseConfig);
const savorDB = getDatabase(app);

document.addEventListener('DOMContentLoaded', () => {
  // Only run on pages that have the settings layout
  const nav = document.querySelector('.settings-nav');
  const content = document.querySelector('.settings-content');
  if (!nav || !content) return;

  const tabs = Array.from(nav.querySelectorAll('[role="tab"]'));
  const panels = Array.from(document.querySelectorAll('.panel'));

    // Fix: you used inventoryTab later but never defined it
    const inventoryTab = document.getElementById('tab-security');

// Keep items in memory so we can append new ones
let inventoryItems = [];

// Track add vs edit mode
let editMode = false;
let editingItemId = '';
let editingExistingImage = '';

  // Helper: show the panel controlled by a tab
  function showPanel(tabEl) {
    // Update tab states
    tabs.forEach(btn => {
      const isActive = btn === tabEl;
      btn.classList.toggle('is-active', isActive);
      btn.setAttribute('aria-selected', String(isActive));
      btn.setAttribute('tabindex', isActive ? '0' : '-1');
      // Ensure nav buttons never submit forms
      if (!btn.getAttribute('type')) btn.setAttribute('type', 'button');
    });

    // Hide all panels
    panels.forEach(panel => {
      panel.hidden = true;
      panel.classList.remove('is-visible');
    });

    // Show target panel
    const targetId = tabEl.getAttribute('aria-controls');
    const target = document.getElementById(targetId);
    if (target) {
      target.hidden = false;
      target.classList.add('is-visible');

      // Move focus to first heading for accessibility
      const heading = target.querySelector('h1, h2, h3, h4, [role="heading"]');
      if (heading) {
        // Make sure it can receive focus momentarily
        if (!heading.hasAttribute('tabindex')) heading.setAttribute('tabindex', '-1');
        heading.focus();
      }
    }
  }

  // Wire click + keyboard navigation
  tabs.forEach((btn, index) => {
    btn.addEventListener('click', () => showPanel(btn));
    btn.addEventListener('keydown', e => {
      const prevKeys = ['ArrowUp', 'ArrowLeft'];
      const nextKeys = ['ArrowDown', 'ArrowRight'];
      if (prevKeys.includes(e.key)) {
        e.preventDefault();
        const prev = tabs[(index - 1 + tabs.length) % tabs.length];
        prev.focus();
        showPanel(prev);
      } else if (nextKeys.includes(e.key)) {
        e.preventDefault();
        const next = tabs[(index + 1) % tabs.length];
        next.focus();
        showPanel(next);
      }
    });
  });

  
  // Initialize: use the one marked .is-active, or fall back to the first
  const initial = tabs.find(t => t.classList.contains('is-active')) || tabs[0];
  if (initial) showPanel(initial);

  // --- Inventory functionality ---
  const inventoryPanel = document.getElementById('panel-security');
  if (inventoryPanel) {
    inventoryPanel.addEventListener('click', async e => {

      // Delete button
      if (e.target.classList.contains('delete-btn')) {
        const itemDiv = e.target.closest('.inventory-item');
        const id = itemDiv?.dataset?.id || '';
        if (!id) return;

        const ok = confirm('Delete this item?');
        if (!ok) return;

        try {
          await remove(ref(savorDB, `foodItems/${id}`));
          await loadInventory('firebase');
        } catch (err) {
          console.error(err);
          alert('Error deleting item (check Rules).');
        }
        return;
      }

      // Edit button
      if (e.target.classList.contains('edit-btn')) {
        const itemDiv = e.target.closest('.inventory-item');
        const id = itemDiv?.dataset?.id || '';
        if (!id) return;

        const item = inventoryItems.find(x => String(x.id) === String(id));
        if (!item) return;

        openEditModal(item);
        return;
      }

      // Quantity + / -
      if (!e.target.classList.contains('quantity-btn')) return;
      const itemDiv = e.target.closest('.inventory-item');
      const input = itemDiv.querySelector('.quantity-input');
      let value = parseInt(input.value);
      if (e.target.classList.contains('plus')) value++;
      if (e.target.classList.contains('minus') && value > 0) value--;
      input.value = value;

      // Save quantity to Firebase (only if item has id)
      const id = itemDiv?.dataset?.id || '';
      if (id) {
        try {
          await update(ref(savorDB, `foodItems/${id}`), { quantity: value });
        } catch (err) {
          console.error(err);
        }
      }
    });

    inventoryPanel.addEventListener('input', async e => {
      if (!e.target.classList.contains('quantity-input')) return;
      let value = parseInt(e.target.value);
      if (isNaN(value) || value < 0) value = 0;
      e.target.value = value;

      // Save quantity to Firebase (only if item has id)
      const itemDiv = e.target.closest('.inventory-item');
      const id = itemDiv?.dataset?.id || '';
      if (id) {
        try {
          await update(ref(savorDB, `foodItems/${id}`), { quantity: value });
        } catch (err) {
          console.error(err);
        }
      }
    });

    const addBtn = document.getElementById('add-item-btn');
    if (addBtn) {
      addBtn.addEventListener('click', () => openModal());
    }

  }
  // Inventory loader (JSON or Firebase) ---
  async function loadInventory(source = 'json') { // default to json
     let items = [];
     if (source === 'json') {
       try {
         const res = await fetch('../inventory.json'); // <--  local JSON path
         items = await res.json();
       } catch (err) {
         console.error('Error loading JSON inventory:', err);
       }
     } else if (source === 'firebase') {
  try {
    const snapshot = await get(ref(savorDB, 'foodItems'));
    if (snapshot.exists()) {
  const data = snapshot.val(); // {id1: {...}, id2: {...}}
  items = Object.entries(data).map(([id, item]) => ({ id, ...item }));
} else {
  items = [];
}

  } catch (err) {
    console.error('Error loading Firebase inventory:', err);
    items = [];
  }
}

inventoryItems = Array.isArray(items) ? items : [];
populateInventory(inventoryItems);

   }

   //  Function to render inventory items ---
   function populateInventory(items) {
     const list = document.querySelector('.inventory-list');
     if (!list) return;
     list.innerHTML = ''; // clear existing items
     items.forEach(item => {
       const div = document.createElement('div');
       div.classList.add('inventory-item');
       div.dataset.id = item.id || '';

       div.innerHTML = `
         <img src="${item.image || '../img/placeholder.png'}" alt="Item Image" class="item-image"/>
         <div class="item-details">
           <div class="item-description">${item.name || 'Unnamed Item'}</div>
            <div class="item-subdescription">${item.description || ''}</div>
           <div class="item-price">$${(typeof item.price === 'number' ? item.price : Number(item.price || 0)).toFixed(2)}</div>
         </div>

         <div class="item-quantity">
           <button class="quantity-btn minus">-</button>
           <input type="number" class="quantity-input" value="${item.quantity ?? 0}" min="0"/>
           <button class="quantity-btn plus">+</button>
         </div>

         <div class="item-actions">
           <button type="button" class="item-action-btn edit-btn">Edit</button>
           <button type="button" class="item-action-btn delete-btn">Delete</button>
         </div>
       `;
       list.appendChild(div);
     });
   }

   const modal = document.getElementById('addItemModal');
    const closeModalBtn = document.getElementById('closeAddItemModal');
    const cancelBtn = document.getElementById('cancelItemBtn');
    const saveBtn = document.getElementById('saveItemBtn');
    const statusEl = document.getElementById('addItemStatus');

    const dropZone = document.getElementById('imageDropZone');
    const fileInput = document.getElementById('itemImageInput');
    const previewImg = document.getElementById('imagePreview');

    const nameInput = document.getElementById('itemName');
    const descInput = document.getElementById('itemDescription');
    const qtyInput = document.getElementById('itemQuantity');
    const priceInput = document.getElementById('itemPrice');

    const titleEl = document.getElementById('addItemTitle');

    let imageDataUrl = '';

    function clearValidation() {
      [nameInput, descInput, qtyInput, priceInput].forEach(i => i.classList.remove('is-invalid'));
      dropZone.classList.remove('is-invalid');
    }

    function resetForm() {
      nameInput.value = '';
      descInput.value = '';
      qtyInput.value = '';
      priceInput.value = '';
      imageDataUrl = '';
      previewImg.src = '';
      dropZone.classList.remove('has-image');
      clearValidation();

      // reset edit mode
      editMode = false;
      editingItemId = '';
      editingExistingImage = '';
      titleEl.textContent = 'Add Inventory Item';
      saveBtn.textContent = 'Save Item';
    }

    function openModal() {
      editMode = false;
      editingItemId = '';
      editingExistingImage = '';
      titleEl.textContent = 'Add Inventory Item';
      saveBtn.textContent = 'Save Item';

      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      statusEl.textContent = '';
      clearValidation();
    }

    function openEditModal(item) {
      editMode = true;
      editingItemId = item.id || '';
      editingExistingImage = item.image || '';

      titleEl.textContent = 'Edit Inventory Item';
      saveBtn.textContent = 'Update Item';

      nameInput.value = item.name || '';
      descInput.value = item.description || '';
      qtyInput.value = String(item.quantity ?? 0);
      priceInput.value = String(item.price ?? 0);

      // show existing image preview (optional)
      imageDataUrl = ''; // means "no new image selected yet"
      if (editingExistingImage) {
        previewImg.src = editingExistingImage;
        dropZone.classList.add('has-image');
      } else {
        previewImg.src = '';
        dropZone.classList.remove('has-image');
      }

      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      statusEl.textContent = '';
      clearValidation();
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
      resetForm();
    }

    function validateForm() {
      clearValidation();
      let ok = true;

      if (!nameInput.value.trim()) { nameInput.classList.add('is-invalid'); ok = false; }
      if (!descInput.value.trim()) { descInput.classList.add('is-invalid'); ok = false; }

      const qty = qtyInput.value.trim();
      if (qty === '' || Number.isNaN(Number(qty)) || Number(qty) < 0) { qtyInput.classList.add('is-invalid'); ok = false; }

      const price = priceInput.value.trim();
      if (price === '' || Number.isNaN(Number(price)) || Number(price) < 0) { priceInput.classList.add('is-invalid'); ok = false; }

      // Image required (remove this if you want it optional)
      // For edit mode: image can be left as-is (existing image)
      if (!editMode) {
        if (!imageDataUrl) { dropZone.classList.add('is-invalid'); ok = false; }
      } else {
        if (!imageDataUrl && !editingExistingImage) { dropZone.classList.add('is-invalid'); ok = false; }
      }

      return ok;
    }

    function setImageFromFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      const reader = new FileReader();
      reader.onload = () => {
        imageDataUrl = String(reader.result || '');
        previewImg.src = imageDataUrl;
        dropZone.classList.add('has-image');
        dropZone.classList.remove('is-invalid');
      };
      reader.readAsDataURL(file);
    }

    // Dropzone click -> file picker
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => setImageFromFile(fileInput.files?.[0]));

    // Drag + drop
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('is-dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('is-dragover'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('is-dragover');
      setImageFromFile(e.dataTransfer.files?.[0]);
    });

    // Close buttons + backdrop close
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });

    // Download updated inventory.json (browser can't write to ../inventory.json directly)
    function downloadInventoryJson(items) {
      const json = JSON.stringify(items, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventory.json';
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    // Hook Add Item button (IMPORTANT: after openModal exists)
    const addBtn = document.getElementById('add-item-btn');
    if (addBtn) addBtn.addEventListener('click', openModal);

    // Save item
    saveBtn.addEventListener('click', async () => {
  if (!validateForm()) {
    statusEl.textContent = 'Please fill in the highlighted fields.';
    return;
  }

  // Decide which image to save:
  // - If user picked a new one: imageDataUrl
  // - Else if editing: keep old editingExistingImage
  // - Else (add mode): must have imageDataUrl because validation
  const finalImage = imageDataUrl || editingExistingImage || '';

  const payload = {
    name: nameInput.value.trim(),
    image: finalImage,                // currently storing base64 from dropzone
    description: descInput.value.trim(),
    quantity: Number(qtyInput.value),
    price: Number(priceInput.value),
    updatedAt: Date.now()
  };

  try {
    if (!editMode) {
      const newItem = {
        ...payload,
        createdAt: Date.now()
      };

      // Save to: /foodItems/<autoId>
      const newItemRef = push(ref(savorDB, 'foodItems'));
      await set(newItemRef, newItem);

      statusEl.textContent = 'Saved to Firebase!';
      closeModal();

      // Reload from Firebase so UI matches DB
      await loadInventory('firebase');
      return;
    }

    // EDIT MODE
    if (!editingItemId) {
      statusEl.textContent = 'Missing item id.';
      return;
    }

    await update(ref(savorDB, `foodItems/${editingItemId}`), payload);

    statusEl.textContent = 'Updated in Firebase!';
    closeModal();
    await loadInventory('firebase');

  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Error saving to Firebase (check Rules).';
  }
});


 


loadInventory('firebase');
if (inventoryTab) inventoryTab.addEventListener('click', () => loadInventory('firebase'));


});
</script>
</body>
</html>
