<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nearby Restaurants Finder</title>
  <style>
    :root{
      --bg:#90eebf;          /* light green */
      --card:#111a33;        /* card background */
      --text:#f6f7fb;        /* primary text */
      --muted:#b8c0d6;       /* secondary text */
      --acc:#7aa2ff;         /* accent */
      --ok:#24c18c;          /* success */
      --warn:#f2c1f5;        /* warning */
      --err:#ff6b6b;         /* error */
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #15224a 0%, transparent 60%),
                  radial-gradient(1200px 600px at 120% 10%, #1d2c5c 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{width:100%; max-width:980px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .title{font-weight:800; font-size:clamp(22px,3vw,32px); letter-spacing:.3px}
    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .btn{background:linear-gradient(180deg, #2a3972, #1f2b55); color:white; border:none; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow:var(--shadow); transition:transform .08s ease, filter .2s ease}
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.sec{background:#20305e}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; margin-bottom:14px}
    .searchbar{display:flex; gap:10px; flex-wrap:wrap}
    .input{flex:1; min-width:240px; background:#0f1832; color:var(--text); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:10px 12px; outline:none; box-shadow:inset 0 0 0 1px transparent; transition:box-shadow .15s ease}
    .input:focus{box-shadow:inset 0 0 0 1px var(--acc)}
    .status{margin:10px 2px; font-size:14px; color:var(--muted)}
    .status strong{color:var(--text)}
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px}
    .item{display:flex; flex-direction:column; gap:8px; padding:14px; border-radius:14px; background:#0e1730; border:1px solid rgba(255,255,255,.06)}
    .item h3{margin:0; font-size:17px}
    .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:13px}
    .chips{display:flex; gap:6px; flex-wrap:wrap}
    .chip{padding:4px 8px; border-radius:999px; background:rgba(122,162,255,.15); color:#cfe0ff; font-size:12px}
    .links{display:flex; gap:8px; margin-top:6px; flex-wrap:wrap}
    .link{font-weight:600; font-size:13px; color:white; text-decoration:none; background:#1a2753; padding:8px 10px; border-radius:10px}
    .dist{margin-left:auto; color:#d5e1ff; background:#12204a; padding:6px 10px; border-radius:10px; font-size:12px}
    footer{opacity:.7; text-align:center; margin-top:18px; font-size:12px; color:var(--muted)}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">üçΩÔ∏è Savor App</div>
      <div class="controls">
        <button id="locBtn" class="btn">üìç Use My Location</button>
        <button id="demoBtn" class="btn sec">üß™ Demo (Times Square)</button>
      </div>
    </header>
    <div class="card">
      <div class="searchbar">
        <input id="addr" class="input" placeholder="Or type a place (e.g., '1600 Amphitheatre Pkwy, Mountain View')" />
        <button id="addrBtn" class="btn">üîé Search</button>
        <select id="radius" class="input" style="max-width:160px">
          <option value="800">Radius: 0.5 mi</option>
          <option value="1500" selected>Radius: 1 mi</option>
          <option value="3000">Radius: 2 mi</option>
          <option value="5000">Radius: 3 mi</option>
        </select>
      </div>
      <div id="status" class="status" aria-live="polite">Ready. Click <strong>Use My Location</strong> to find restaurants around you.</div>
    </div>
    <div id="results" class="grid" aria-live="polite"></div>
    <footer>
      Data from OpenStreetMap via Overpass API ‚Ä¢ distances are approximate ‚Ä¢ no API key required
    </footer>
  </div>

  <script>
    // ===== Helpers =====
    const qs = s => document.querySelector(s);
    const statusEl = qs('#status');
    const resultsEl = qs('#results');
    const addrInp = qs('#addr');

    const kmToMiles = km => km * 0.621371;
    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI/180;
      const dLon = (lon2 - lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // km
    }
    const setStatus = msg => { statusEl.textContent = msg; };
    const escapeHtml = str => (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));

    // ===== Rendering =====
    function render(results, origin){
      resultsEl.innerHTML = '';
      if(!results.length){ setStatus('No restaurants found in this area. Try increasing the radius or moving the map.'); return; }
      const frag = document.createDocumentFragment();
      for(const r of results){
        const div = document.createElement('div');
        div.className = 'item';
        const name = escapeHtml(r.tags.name || 'Unnamed Restaurant');
        const cuisines = (r.tags.cuisine||'').split(';').filter(Boolean).slice(0,3);
        const addrParts = ['addr:housenumber','addr:street','addr:city'].map(k=>r.tags[k]).filter(Boolean);
        const distKm = r.__distKm ?? haversine(origin.lat, origin.lon, r.lat, r.lon);
        const distLabel = distKm < 1 ? (Math.round(distKm * 1000)) + ' m' : kmToMiles(distKm).toFixed(1) + ' mi';
        div.innerHTML = `
          <div style="display:flex; gap:8px; align-items:center;">
            <h3>${name}</h3>
            <span class="dist">${distLabel}</span>
          </div>
          <div class="meta">${addrParts.map(escapeHtml).join(', ') || 'Address not listed'}</div>
          <div class="chips">${cuisines.map(c=>`<span class="chip">${escapeHtml(c)}</span>`).join('')}</div>
          <div class="links">
            <a class="link" href="https://www.google.com/maps/search/?api=1&query=${r.lat},${r.lon}" target="_blank" rel="noopener">Open in Maps</a>
            <a class="link" href="https://www.openstreetmap.org/${r.osmType}/${r.id}" target="_blank" rel="noopener">OpenStreetMap</a>
          </div>
        `;
        frag.appendChild(div);
      }
      resultsEl.appendChild(frag);
      setStatus(`Found ${results.length} places. Sorted by distance.`);
    }

    // ===== Geocoding (Nominatim) =====
    // Use jsonv2, respect language, limit=1. (Browsers cannot set User-Agent header.)
    async function geocodeAddress(addr){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('format','jsonv2');
      url.searchParams.set('q', addr);
      url.searchParams.set('limit','1');
      url.searchParams.set('addressdetails','1');
      url.searchParams.set('accept-language', navigator.language || 'en');
      const res = await fetch(url.toString(), { headers: { 'Accept':'application/json' } });
      if(!res.ok) throw new Error('Geocoding failed');
      const data = await res.json();
      if(!data.length) throw new Error('Location not found');
      return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
    }

    // ===== Places (Overpass) =====
    // Query nodes/ways/relations and request center for non-node geometries.
    async function fetchPlaces(origin, radiusMeters){
      const query = `
        [out:json][timeout:25];
        (
          node(around:${radiusMeters},${origin.lat},${origin.lon})[amenity~"restaurant|cafe|fast_food|food_court"];
          way(around:${radiusMeters},${origin.lat},${origin.lon})[amenity~"restaurant|cafe|fast_food|food_court"];
          relation(around:${radiusMeters},${origin.lat},${origin.lon})[amenity~"restaurant|cafe|fast_food|food_court"];
        );
        out center qt;
      `;
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
        body: new URLSearchParams({ data: query }).toString()
      });
      if(!res.ok) throw new Error('Overpass request failed');
      const data = await res.json();
      return (data.elements||[])
        .map(e=>{
          const isNode = e.type === 'node';
          const center = isNode ? {lat:e.lat, lon:e.lon} : (e.center || {});
          return { id:e.id, lat:center.lat, lon:center.lon, tags:e.tags||{}, osmType: e.type };
        })
        .filter(x=> Number.isFinite(x.lat) && Number.isFinite(x.lon));
    }

    function withDistances(list, origin){
      return list.map(it=>({ ...it, __distKm: haversine(origin.lat, origin.lon, it.lat, it.lon) }))
                 .sort((a,b)=>a.__distKm - b.__distKm);
    }

    let lastOrigin = null;           // remembered for radius changes
    let inFlightAbort = null;        // cancel previous Overpass request

    async function runSearch(origin){
      lastOrigin = origin;
      const rad = parseInt(qs('#radius').value,10);
      setStatus('Searching for places nearby‚Ä¶');
      resultsEl.innerHTML = '';

      // cancel any previous Overpass request
      if(inFlightAbort){ inFlightAbort.abort(); }
      inFlightAbort = new AbortController();

      try{
        const items = await fetchPlaces(origin, rad, { signal: inFlightAbort.signal });
        const sorted = withDistances(items, origin).slice(0, 80);
        render(sorted, origin);
      }catch(err){
        if(err.name === 'AbortError') return; // a new search started
        console.error(err);
        setStatus('Error fetching places. Try again or reduce radius.');
      } finally {
        inFlightAbort = null;
      }
    }

    // ===== Events =====
    qs('#locBtn').addEventListener('click', () => {
      if(!('geolocation' in navigator)){
        setStatus('Geolocation not supported in this browser. Type an address instead.');
        return;
      }
      setStatus('Requesting your location‚Ä¶');
      navigator.geolocation.getCurrentPosition(pos => {
        const origin = {lat: pos.coords.latitude, lon: pos.coords.longitude};
        setStatus(`Location acquired. lat ${origin.lat.toFixed(4)}, lon ${origin.lon.toFixed(4)}. Searching‚Ä¶`);
        runSearch(origin);
      }, () => {
        setStatus('Location permission denied. Type an address above and click Search.');
      }, {enableHighAccuracy:false, timeout:12000, maximumAge:60000});
    });

    qs('#addrBtn').addEventListener('click', async () => {
      const txt = addrInp.value.trim();
      if(!txt){ setStatus('Please type an address or city.'); return; }
      setStatus('Geocoding‚Ä¶');
      try{
        const origin = await geocodeAddress(txt);
        setStatus(`Searching near ${txt}‚Ä¶`);
        runSearch(origin);
      }catch(e){ setStatus('Could not find that place. Try a more specific address.'); }
    });

    // Enter key triggers address search
    addrInp.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') qs('#addrBtn').click();
    });

    qs('#radius').addEventListener('change', () => {
      if(lastOrigin){ runSearch(lastOrigin); }
    });

    // Demo button: Times Square, NYC
    qs('#demoBtn').addEventListener('click', () => {
      const origin = {lat: 40.7580, lon: -73.9855};
      setStatus('Demo mode: Times Square, NYC. Searching‚Ä¶');
      runSearch(origin);
    });
  </script>
</body>
</html>
